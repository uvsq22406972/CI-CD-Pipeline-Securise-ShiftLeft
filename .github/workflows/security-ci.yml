name: Securite CI

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  securite:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Installer pipx
        run: |
          python -m pip install --upgrade pip
          python -m pip install pipx
          python -m pipx ensurepath
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Installer outils securite (pipx)
        run: |
          pipx install semgrep
          pipx install pip-audit

      - name: Creer dossier rapports
        run: mkdir -p rapports

      - name: SAST - Semgrep (rapport)
        run: |
          semgrep --config p/default --config .semgrep.yml --json -o rapports/semgrep.json . || true

      - name: SAST - Semgrep (gate ERROR)
        run: |
          semgrep --config p/default --config .semgrep.yml --severity ERROR --error .

      - name: SCA - pip-audit (rapport)
        run: |
          pip-audit -r requirements.txt -f json -o rapports/pip-audit.json

      - name: SCA - pip-audit (gate)
        run: |
          pip-audit -r requirements.txt

      - name: Build image Docker
        run: |
          docker build -t flaskauth:ci .

      - name: Trivy image (gate HIGH/CRITICAL + rapport)
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity HIGH,CRITICAL --exit-code 1 \
            --format json -o rapports/trivy-image.json \
            flaskauth:ci

      - name: Lancer l'app (compose)
        run: |
          docker compose up -d --build
          # attendre que l'app reponde
          for i in {1..60}; do
            if curl -fsS http://localhost:8080/ >/dev/null; then
              echo "App UP"
              break
            fi
            sleep 2
          done

      - name: DAST - OWASP ZAP baseline (rapport)
        run: |
          docker run --rm --network host -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://localhost:8080 \
            -r rapports/zap.html -J rapports/zap.json -x rapports/zap.xml

      - name: Stop compose
        if: always()
        run: docker compose down

      - name: Upload rapports securite
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rapports-securite
          path: rapports/
