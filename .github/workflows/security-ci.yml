name: Securite CI

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  securite:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Installer pipx
        run: |
          python -m pip install --upgrade pip
          python -m pip install pipx
          python -m pipx ensurepath
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Installer outils securite (pipx)
        run: |
          pipx install semgrep
          pipx install pip-audit

      - name: Creer dossier rapports
        run: mkdir -p rapports

      - name: SAST - Semgrep (rapport)
        run: |
          semgrep --metrics=off --config p/default --config .semgrep.yml --json -o rapports/semgrep.json . || true

      - name: SAST - Semgrep (gate ERROR)
        run: |
          semgrep --config p/default --config .semgrep.yml --severity ERROR --error .

      - name: SCA - pip-audit (rapport)
        run: |
          pip-audit -r requirements.txt -f json -o rapports/pip-audit.json

      - name: SCA - pip-audit (gate)
        run: |
          pip-audit -r requirements.txt

      - name: Build image Docker (no cache)
        run: |
          docker build --no-cache -t flaskauth:ci .

      - name: Trivy image (gate CRITICAL + rapport)
        run: |
          docker run --rm \ 
          -v /var/run/docker.sock:/var/run/docker.sock \ 
          -v "$PWD/rapports:/rapports" \ 
          aquasec/trivy:0.5x.x image \ 
          --severity HIGH,CRITICAL \ 
          --format json -o /rapports/trivy-image.json \ 
          flaskauth:ci docker run --rm \ 
          -v /var/run/docker.sock:/var/run/docker.sock \ 
          aquasec/trivy:0.5x.x image \ 
          --severity CRITICAL --exit-code 1 \ 
          flaskauth:ci

      - name: Create docker network
        run: docker network create zapnet || true

      - name: Lancer l'app (docker run)
        run: |
          docker rm -f flaskauth >/dev/null 2>&1 || true
          docker run -d --name flaskauth --network zapnet -p 8080:8080 \
            -e SESSION_COOKIE_SECURE=false \
            -e REMEMBER_COOKIE_SECURE=false \
            -e ZAP_SCAN=true \
            flaskauth:ci
            

          ok=0
          for i in {1..60}; do
            if curl -fsS http://localhost:8080/ >/dev/null; then
              echo "App UP"
              ok=1
              break
            fi
            sleep 2
          done
          if [ "$ok" -ne 1 ]; then
            echo "App did not start in time"
            docker logs --tail=200 flaskauth || true
            exit 1
          fi

      - name: DAST - OWASP ZAP baseline (gate FAIL only)
        run: |
          mkdir -p rapports
          chmod -R 777 rapports

          set +e
          out=$(docker run --rm --network zapnet -t \
            -v "${{ github.workspace }}/rapports:/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://flaskauth:8080 \
            -r zap.html -J zap.json -x zap.xml)
          ec=$?
          echo "$out"
          echo "ZAP raw exit code: $ec"

          # Extraire la ligne de synthèse
          summary=$(echo "$out" | grep -E "FAIL-NEW:" | tail -n 1 || true)
          echo "Summary: $summary"

          # Si FAIL-NEW n'est pas 0 => on échoue
          if echo "$summary" | grep -qv "FAIL-NEW: 0"; then
            echo "ZAP gate failed (FAIL-NEW > 0)"
            exit 1
          fi

          echo "ZAP gate passed (FAIL-NEW = 0). Allowing warnings."
          exit 0

      - name: Stop app
        if: always()
        run: docker rm -f flaskauth


      - name: Upload rapports securite
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rapports-securite
          path: rapports/
